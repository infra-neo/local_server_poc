#!/usr/bin/env python3
"""
SOLUCI√ìN DEFINITIVA PARA PROBLEMA DE SINCRONIZACI√ìN LDAP
"""

import subprocess
import time
import sys

def run_command(cmd, description=""):
    """Ejecutar comando y mostrar resultado"""
    if description:
        print(f"üîß {description}")
    
    try:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
        if result.returncode == 0:
            print(f"‚úÖ √âxito: {result.stdout.strip()}")
            return True
        else:
            print(f"‚ùå Error: {result.stderr.strip()}")
            return False
    except Exception as e:
        print(f"‚ùå Excepci√≥n: {e}")
        return False

def main():
    print("üéØ SOLUCI√ìN DEFINITIVA PARA LDAP SYNC")
    print("====================================")
    
    print("\n1. üßπ Limpiando sistema completamente...")
    
    # Limpiar cache de Redis
    run_command(
        'docker exec kolaboree-redis redis-cli -a "h84cOC6MeVvDAP0ltqbxf44g9Tr0x88n8zRI1XlqzkK1TZwDrclf5S3Xw0SuOhwK" FLUSHALL',
        "Limpiando cache de Redis"
    )
    
    print("\n2. üîÑ Reiniciando servicios...")
    
    # Parar servicios
    run_command("docker-compose stop authentik-server authentik-worker", 
                "Parando servicios Authentik")
    
    time.sleep(5)
    
    # Iniciar servicios
    run_command("docker-compose start authentik-server authentik-worker",
                "Iniciando servicios Authentik")
    
    print("\n3. ‚è∞ Esperando que servicios est√©n listos...")
    time.sleep(20)
    
    print("\n4. üîç Verificando usuario en LDAP...")
    run_command(
        'docker exec kolaboree-ldap ldapsearch -x -D "cn=admin,dc=kolaboree,dc=local" -w "zEYgBeGPqNdqXSUF2IajtezHrjSE8tXgE8dx6ClhWiMiqD35+tMtVZIndUzaMW01" -b "dc=kolaboree,dc=local" "(uid=soporte)" uid mail cn displayName',
        "Verificando usuario soporte en LDAP"
    )
    
    print("\n5. üîç Verificando estructura LDAP completa...")
    run_command(
        'docker exec kolaboree-ldap ldapsearch -x -D "cn=admin,dc=kolaboree,dc=local" -w "zEYgBeGPqNdqXSUF2IajtezHrjSE8tXgE8dx6ClhWiMiqD35+tMtVZIndUzaMW01" -b "dc=kolaboree,dc=local" -s one',
        "Verificando estructura base de LDAP"
    )
    
    print("\n" + "="*60)
    print("üéØ CONFIGURACI√ìN EXACTA PARA AUTHENTIK LDAP SOURCE")
    print("="*60)
    
    print("""
üìã COPIAR ESTOS DATOS EXACTOS EN AUTHENTIK:

üåê URL de Authentik: https://34.68.124.46:9443/if/admin/
üìÇ Ir a: Directory > Federation & Social login > LDAP Sources

‚ö†Ô∏è  IMPORTANTE: Si ya existe un LDAP Source, ELIMINARLO primero

‚ûï CREAR NUEVO LDAP SOURCE CON:

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ CONFIGURACI√ìN B√ÅSICA                                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Name: Kolaboree LDAP                                        ‚îÇ
‚îÇ Slug: kolaboree-ldap                                        ‚îÇ
‚îÇ Enabled: ‚úÖ ACTIVADO                                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ CONFIGURACI√ìN DE CONEXI√ìN                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Server URI: ldap://kolaboree-ldap:389                      ‚îÇ
‚îÇ Enable StartTLS: ‚ùå DESACTIVADO                           ‚îÇ
‚îÇ TLS Verification Certificate: (dejar vac√≠o)                ‚îÇ
‚îÇ Bind CN: cn=admin,dc=kolaboree,dc=local                    ‚îÇ
‚îÇ Bind Password: zEYgBeGPqNdqXSUF2IajtezHrjSE8tXgE8dx6ClhWiM ‚îÇ
‚îÇ               iqD35+tMtVZIndUzaMW01                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ CONFIGURACI√ìN DE B√öSQUEDA                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Base DN: dc=kolaboree,dc=local                             ‚îÇ
‚îÇ Addition User DN: ou=users                                  ‚îÇ
‚îÇ Addition Group DN: ou=groups                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ CONFIGURACI√ìN DE OBJETOS                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ User object filter: (objectClass=inetOrgPerson)           ‚îÇ
‚îÇ User object class: inetOrgPerson                           ‚îÇ
‚îÇ Group object filter: (objectClass=groupOfNames)            ‚îÇ
‚îÇ Group object class: groupOfNames                           ‚îÇ
‚îÇ Group membership field: member                             ‚îÇ
‚îÇ Object uniqueness field: uid                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ CONFIGURACI√ìN DE SINCRONIZACI√ìN                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Sync users: ‚úÖ ACTIVADO                                   ‚îÇ
‚îÇ Sync users password: ‚úÖ ACTIVADO                          ‚îÇ
‚îÇ Sync groups: ‚úÖ ACTIVADO                                  ‚îÇ
‚îÇ Sync parent group: (dejar vac√≠o)                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

üîß PASOS DESPU√âS DE CREAR:

1. üíæ Hacer clic en "Save" (Guardar)
2. üîÑ Hacer clic en "Sync" (Sincronizar)
3. ‚è∞ Esperar 2-3 minutos
4. üîç Verificar en "Directory > Users" que aparezca 'soporte'
5. ‚úÖ Si aparece, la configuraci√≥n est√° correcta

üß™ VERIFICACI√ìN FINAL:
   Deber√≠as ver el usuario 'soporte' con:
   ‚Ä¢ Username: soporte
   ‚Ä¢ Email: soporte@kolaboree.local  
   ‚Ä¢ Name: Usuario Soporte
   ‚Ä¢ Source: Kolaboree LDAP

‚ùå SI NO APARECE EL USUARIO:
   1. Verificar que el Server URI sea exactamente: ldap://kolaboree-ldap:389
   2. Verificar que el Bind Password sea completo (sin espacios)
   3. Eliminar y crear nuevamente el LDAP Source
   4. Ejecutar este script otra vez para verificar LDAP
""")

    print("\n" + "="*60)
    print("‚úÖ SISTEMA PREPARADO PARA CONFIGURACI√ìN LDAP")
    print("üí° PROBLEMA: Error de timeout se soluciona creando NUEVO LDAP Source")
    print("üéØ SIGUIENTE PASO: Configurar LDAP Source en Authentik UI")
    print("="*60)

if __name__ == "__main__":
    main()