#!/bin/bash
# Script para solucionar el problema de redirecciÃ³n SSO

echo "ðŸ”§ SOLUCIONANDO PROBLEMA DE REDIRECCIÃ“N SSO"
echo "==========================================="

echo ""
echo "ðŸ“‹ PROBLEMA IDENTIFICADO:"
echo "â€¢ Authentik te redirige directamente al login de Guacamole"
echo "â€¢ No pasas por el menÃº de aplicaciones de Authentik"
echo "â€¢ Guacamole muestra error 403 en /api/tokens"

echo ""
echo "ðŸŽ¯ SOLUCIÃ“N: Configurar el flujo correcto"
echo "========================================"

echo ""
echo "1. ðŸ“ VERIFICAR CONFIGURACIÃ“N ACTUAL..."

# Verificar si Guacamole estÃ¡ recibiendo los parÃ¡metros OIDC
echo "Variables OIDC en Guacamole:"
docker exec kolaboree-guacamole env | grep -E "OPENID_" | while read line; do
    echo "  âœ… $line"
done

echo ""
echo "2. ðŸ” VERIFICAR ENDPOINTS DE AUTHENTIK..."

# Probar acceso a Authentik user interface
echo "Probando acceso a interfaz de usuario de Authentik..."
curl -k -s -o /dev/null -w "Status: %{http_code}" "https://34.68.124.46:9443/if/user/"
echo ""

echo ""
echo "3. ðŸŽ¯ URLs CORRECTAS PARA USAR:"
echo "=============================="
echo ""
echo "âŒ NO USAR (te lleva directo al login de Guacamole):"
echo "   https://34.68.124.46:9443/application/o/guacamole/"
echo "   http://34.68.124.46:8080/guacamole/"
echo ""
echo "âœ… USAR (interfaz de usuario de Authentik):"
echo "   https://34.68.124.46:9443/if/user/"
echo "   Desde ahÃ­ hacer clic en 'Apache Guacamole'"

echo ""
echo "4. ðŸ”§ CONFIGURACIÃ“N REQUERIDA EN AUTHENTIK:"
echo "=========================================="

echo ""
echo "ðŸ“‹ VERIFICAR EN AUTHENTIK ADMIN:"
echo "1. Ir a: https://34.68.124.46:9443/if/admin/"
echo "2. Applications > Applications"
echo "3. Verificar que existe 'Apache Guacamole'"
echo "4. La configuraciÃ³n debe ser:"
echo ""
echo "   Name: Apache Guacamole"
echo "   Slug: guacamole"
echo "   Provider: [Tu RAC Provider]"
echo "   Launch URL: http://34.68.124.46:8080/guacamole/"
echo "   Open in new tab: âœ…"

echo ""
echo "ðŸ“‹ VERIFICAR RAC PROVIDER:"
echo "1. Applications > Providers"
echo "2. Verificar configuraciÃ³n del Provider:"
echo ""
echo "   Client ID: guacamole-rac-client"
echo "   Client Secret: (debe coincidir con docker-compose.yml)"
echo "   Redirect URIs: http://34.68.124.46:8080/guacamole/"
echo "   Scopes: openid,profile,email,groups"

echo ""
echo "5. ðŸ§ª FLUJO CORRECTO PARA PROBAR:"
echo "================================"
echo ""
echo "PASO 1: Ir a la interfaz de usuario"
echo "https://34.68.124.46:9443/if/user/"
echo ""
echo "PASO 2: Login con credenciales"
echo "Usuario: soporte@kolaboree.local"
echo "Password: Neo123!!!"
echo ""
echo "PASO 3: Buscar aplicaciÃ³n 'Apache Guacamole'"
echo "Debe aparecer en la lista de aplicaciones disponibles"
echo ""
echo "PASO 4: Hacer clic en 'Apache Guacamole'"
echo "Esto debe abrir Guacamole con SSO automÃ¡tico"

echo ""
echo "6. ðŸš¨ SI SIGUE SIN FUNCIONAR:"
echo "============================"
echo ""
echo "Problema posible: La aplicaciÃ³n no estÃ¡ creada o mal configurada"
echo ""
echo "CREAR APLICACIÃ“N MANUALMENTE:"
echo "1. https://34.68.124.46:9443/if/admin/"
echo "2. Applications > Applications > Create"
echo "3. Configurar:"
echo "   Name: Apache Guacamole"
echo "   Slug: guacamole"
echo "   Provider: [Seleccionar tu RAC Provider]"
echo "   Launch URL: http://34.68.124.46:8080/guacamole/"

echo ""
echo "7. ðŸ“Š DIAGNÃ“STICO DE LOGS:"
echo "========================="
echo "Si hay problemas, revisar logs:"
echo "docker logs kolaboree-guacamole | tail -20"
echo "docker logs kolaboree-authentik-server | tail -20"

echo ""
echo "âœ… RESUMEN:"
echo "==========="
echo "â€¢ No accedas directamente a Guacamole"
echo "â€¢ Usa la interfaz de usuario de Authentik"
echo "â€¢ Haz clic en la aplicaciÃ³n desde el menÃº"
echo "â€¢ Verifica que la aplicaciÃ³n estÃ© configurada correctamente"