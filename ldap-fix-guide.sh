#!/bin/bash
# GuÃ­a paso a paso para resolver el problema de sincronizaciÃ³n LDAP

echo "ðŸ”§ GUÃA PASO A PASO - RESOLVER PROBLEMA LDAP"
echo "============================================="

echo ""
echo "âŒ PROBLEMA ACTUAL:"
echo "   'Could not find page in cache: goauthentik.io/sources/ldap/page/...'"
echo "   'Try increasing ldap.task_timeout_h    ours'"

echo ""
echo "âœ… CAUSA IDENTIFICADA:"
echo "   El LDAP Source tiene una configuraciÃ³n incorrecta o corrupta"
echo "   que estÃ¡ causando timeouts en las tareas de sincronizaciÃ³n."

echo ""
echo "ðŸŽ¯ SOLUCIÃ“N DEFINITIVA:"
echo ""

echo "PASO 1: Eliminar LDAP Source existente"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "1. Ir a: https://34.68.124.46:9443/if/admin/"
echo "2. Hacer login como akadmin"
echo "3. Ir a: Directory > Federation & Social login > LDAP Sources"
echo "4. Si hay algÃºn LDAP Source existente, hacer clic en âŒ Delete"
echo "5. Confirmar eliminaciÃ³n"
echo ""

echo "PASO 2: Crear nuevo LDAP Source"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "1. En la misma pÃ¡gina, hacer clic en âž• Create"
echo "2. Llenar EXACTAMENTE con estos datos:"
echo ""
echo "   ðŸ“‹ CONFIGURACIÃ“N EXACTA:"
echo "   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "   â”‚ Name: Kolaboree LDAP                                    â”‚"
echo "   â”‚ Slug: kolaboree-ldap-new                                â”‚"
echo "   â”‚ Enabled: âœ… (marcado)                                  â”‚"
echo "   â”‚ Authentication flow: default-authentication-flow        â”‚"
echo "   â”‚ Enrollment flow: default-enrollment-flow                â”‚"
echo "   â”‚                                                         â”‚"
echo "   â”‚ CONNECTION SETTINGS:                                    â”‚"
echo "   â”‚ Server URI: ldap://kolaboree-ldap:389                  â”‚"
echo "   â”‚ Enable StartTLS: âŒ (desmarcado)                       â”‚"
echo "   â”‚ TLS Verification Certificate: (vacÃ­o)                   â”‚"
echo "   â”‚ Bind CN: cn=admin,dc=kolaboree,dc=local                â”‚"
echo "   â”‚ Bind Password: zEYgBeGPqNdqXSUF2IajtezHrjSE8tXgE8dx6Cl â”‚"
echo "   â”‚                                                         â”‚"
echo "   â”‚ LDAP ATTRIBUTE MAPPING:                                 â”‚"
echo "   â”‚ Base DN: dc=kolaboree,dc=local                         â”‚"
echo "   â”‚ Additional User DN: ou=users                           â”‚"
echo "   â”‚ Additional Group DN: ou=groups                         â”‚"
echo "   â”‚                                                         â”‚"
echo "   â”‚ USER:                                                   â”‚"
echo "   â”‚ User object filter: (objectClass=inetOrgPerson)       â”‚"
echo "   â”‚ User object class: inetOrgPerson                       â”‚"
echo "   â”‚ Object uniqueness field: uid                           â”‚"
echo "   â”‚                                                         â”‚"
echo "   â”‚ GROUP:                                                  â”‚"
echo "   â”‚ Group object filter: (objectClass=groupOfNames)       â”‚"
echo "   â”‚ Group object class: groupOfNames                       â”‚"
echo "   â”‚ Group membership field: member                         â”‚"
echo "   â”‚                                                         â”‚"
echo "   â”‚ SYNC SETTINGS:                                          â”‚"
echo "   â”‚ Sync users: âœ… (marcado)                              â”‚"
echo "   â”‚ Sync groups: âœ… (marcado)                             â”‚"
echo "   â”‚ Sync parent group: (vacÃ­o)                             â”‚"
echo "   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

echo ""
echo "PASO 3: Guardar y sincronizar"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "1. Hacer clic en ðŸ’¾ Create (guardar)"
echo "2. Esperar a que se guarde"
echo "3. En la lista de LDAP Sources, encontrar el nuevo 'Kolaboree LDAP'"
echo "4. Hacer clic en el botÃ³n ðŸ”„ 'Sync' al lado del LDAP Source"
echo "5. ESPERAR 2-3 minutos (no cerrar la pÃ¡gina)"

echo ""
echo "PASO 4: Verificar sincronizaciÃ³n"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "1. Ir a: Directory > Users"
echo "2. Buscar el usuario 'soporte'"
echo "3. DeberÃ­a aparecer con:"
echo "   â€¢ Username: soporte"
echo "   â€¢ Email: soporte@kolaboree.local" 
echo "   â€¢ Source: Kolaboree LDAP"

echo ""
echo "ðŸ” VERIFICACIÃ“N FINAL:"
echo "Si el usuario 'soporte' aparece en Directory > Users,"
echo "entonces la sincronizaciÃ³n LDAP estÃ¡ funcionando correctamente."

echo ""
echo "ðŸ§ª PRUEBA DEL FLUJO COMPLETO:"
echo "1. Logout de Authentik"
echo "2. Ir a: https://34.68.124.46:9443/application/o/guacamole/"
echo "3. DeberÃ­a redirigir al login de Authentik"
echo "4. Usar: soporte@kolaboree.local / Neo123!!!"
echo "5. DeberÃ­a entrar a Guacamole automÃ¡ticamente"

echo ""
echo "âš ï¸ SI EL PROBLEMA PERSISTE:"
echo "El error puede estar en:"
echo "1. Server URI incorrecto (debe ser kolaboree-ldap:389)"
echo "2. Bind Password incompleto"
echo "3. Cache corrupto (ya lo limpiamos)"

echo ""
echo "âœ… RESUMEN:"
echo "1. âŒ Eliminar LDAP Source existente"
echo "2. âž• Crear nuevo con configuraciÃ³n exacta"
echo "3. ðŸ”„ Sincronizar"
echo "4. âœ… Verificar usuario en Directory > Users"

echo ""
echo "ðŸ“ž Si necesitas ayuda, puedes verificar:"
echo "â€¢ Logs de Authentik: docker logs kolaboree-authentik-server"
echo "â€¢ Usuario en LDAP: ya verificado âœ…"
echo "â€¢ Conectividad: ya verificada âœ…"