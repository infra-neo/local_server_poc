#!/bin/bash
# Script para finalizar configuraci√≥n OIDC en Guacamole

echo "üîß FINALIZANDO CONFIGURACI√ìN OIDC"
echo "================================="

echo "1. üìã Estado actual de configuraci√≥n:"
echo "‚úÖ OIDC ya est√° configurado en docker-compose.yml"
echo "‚úÖ Extensiones OPENID y LDAP est√°n habilitadas"
echo "‚úÖ Endpoints de Authentik est√°n configurados"

echo ""
echo "2. ‚ö†Ô∏è FALTA CONFIGURAR:"
echo "======================"
echo "‚ùå OPENID_CLIENT_SECRET - necesario para completar OIDC"

echo ""
echo "3. üéØ CONFIGURACI√ìN REQUERIDA EN AUTHENTIK:"
echo "==========================================="

echo ""
echo "üìã RAC PROVIDER - CONFIGURACI√ìN EXACTA:"
echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
echo "‚îÇ Name: Guacamole RAC Provider                        ‚îÇ"
echo "‚îÇ Client ID: guacamole-rac-client                     ‚îÇ"
echo "‚îÇ (DEBE coincidir con docker-compose.yml)            ‚îÇ"
echo "‚îÇ                                                     ‚îÇ"
echo "‚îÇ PROTOCOL SETTINGS:                                  ‚îÇ"
echo "‚îÇ Client type: Confidential                           ‚îÇ"
echo "‚îÇ Redirect URIs/Origins:                              ‚îÇ"
echo "‚îÇ   - http://34.68.124.46:8080/guacamole/            ‚îÇ"
echo "‚îÇ                                                     ‚îÇ"
echo "‚îÇ ADVANCED PROTOCOL SETTINGS:                        ‚îÇ"
echo "‚îÇ Scopes: openid,profile,email,groups                ‚îÇ"
echo "‚îÇ Subject mode: Based on the User's ID               ‚îÇ"
echo "‚îÇ Include claims in id_token: ‚úÖ                     ‚îÇ"
echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"

echo ""
echo "üìã APPLICATION - CONFIGURACI√ìN EXACTA:"
echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
echo "‚îÇ Name: Apache Guacamole                              ‚îÇ"
echo "‚îÇ Slug: guacamole                                     ‚îÇ"
echo "‚îÇ Provider: Guacamole RAC Provider                    ‚îÇ"
echo "‚îÇ                                                     ‚îÇ"
echo "‚îÇ UI SETTINGS:                                        ‚îÇ"
echo "‚îÇ Launch URL: http://34.68.124.46:8080/guacamole/    ‚îÇ"
echo "‚îÇ Open in new tab: ‚úÖ                                ‚îÇ"
echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"

echo ""
echo "4. üìù PASOS PARA COMPLETAR:"
echo "=========================="
echo "1. Ir a: https://34.68.124.46:9443/if/admin/"
echo "2. Applications > Providers"
echo "3. Crear/Editar RAC Provider con configuraci√≥n exacta de arriba"
echo "4. ¬°IMPORTANTE! Usar Client ID: guacamole-rac-client"
echo "5. Copiar el Client Secret generado"
echo "6. Actualizar docker-compose.yml con el Client Secret"
echo "7. Reiniciar Guacamole"

echo ""
echo "5. üîç VERIFICAR ENDPOINTS OIDC:"
echo "==============================="
curl -k -s "https://34.68.124.46:9443/application/o/guacamole/.well-known/openid-configuration" | python3 -m json.tool | head -10

echo ""
echo "6. üí° FLUJO ESPERADO DESPU√âS DE CONFIGURAR:"
echo "==========================================="
echo "1. Usuario va a: https://34.68.124.46:9443/if/user/"
echo "2. Hace clic en 'Apache Guacamole'"
echo "3. Authentik genera token OIDC"
echo "4. Redirige a: http://34.68.124.46:8080/guacamole/?token=..."
echo "5. Guacamole valida token con Authentik"
echo "6. Guacamole autentica usuario y muestra conexiones"

echo ""
echo "‚úÖ CONFIGURACI√ìN CASI COMPLETA"
echo "=============================="
echo "Solo falta agregar OPENID_CLIENT_SECRET al docker-compose.yml"