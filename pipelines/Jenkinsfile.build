pipeline {
    agent {
        docker {
            image 'maven:3.8.5-jdk-8'
            args '-v /root/.m2:/root/.m2'
        }
    }
    
    environment {
        NEXUS_URL = credentials('nexus-url')
        NEXUS_CREDENTIALS = credentials('nexus-credentials')
        SONAR_TOKEN = credentials('sonar-token')
        APP_VERSION = "${env.BUILD_NUMBER}"
    }
    
    parameters {
        choice(name: 'ENVIRONMENT', choices: ['dev', 'qa', 'staging', 'production'], description: 'Target environment')
        choice(name: 'JDK_VERSION', choices: ['1.7', '1.8'], description: 'Java version')
        booleanParam(name: 'SKIP_TESTS', defaultValue: false, description: 'Skip unit tests')
        booleanParam(name: 'SECURITY_SCAN', defaultValue: true, description: 'Run security scan')
    }
    
    stages {
        stage('ğŸ” Pre-build Validation') {
            steps {
                script {
                    echo "ğŸ” Starting pre-build validations..."
                    sh 'mvn validate'
                    echo "âœ… POM validation successful"
                }
            }
        }
        
        stage('ğŸ”’ Security Scan') {
            when {
                expression { params.SECURITY_SCAN == true }
            }
            steps {
                script {
                    echo "ğŸ”’ Running security scans..."
                    sh './scripts/validate-secrets.sh'
                    sh 'mvn org.owasp:dependency-check-maven:check'
                    echo "âœ… Security scan completed"
                }
            }
        }
        
        stage('ğŸ“¦ Dependencies Resolution') {
            steps {
                script {
                    echo "ğŸ“¦ Resolving dependencies from Nexus..."
                    sh 'mkdir -p ~/.m2 && cp config/nexus/settings.xml ~/.m2/settings.xml'
                    sh 'mvn dependency:resolve'
                    echo "âœ… Dependencies resolved successfully"
                }
            }
        }
        
        stage('ğŸ—ï¸ Build') {
            steps {
                script {
                    echo "ğŸ—ï¸ Building application..."
                    def mvnCmd = "mvn clean package -P${params.ENVIRONMENT}"
                    if (params.SKIP_TESTS) {
                        mvnCmd += " -DskipTests"
                    }
                    sh mvnCmd
                    echo "âœ… Build completed successfully"
                }
            }
        }
        
        stage('ğŸ§ª Unit Tests') {
            when {
                expression { params.SKIP_TESTS == false }
            }
            steps {
                script {
                    echo "ğŸ§ª Running unit tests..."
                    sh 'mvn test'
                    junit '**/target/surefire-reports/*.xml'
                    echo "âœ… Unit tests completed"
                }
            }
        }
        
        stage('ğŸ“Š Code Quality Analysis') {
            steps {
                script {
                    echo "ğŸ“Š Running code quality analysis..."
                    sh 'mvn sonar:sonar -Dsonar.host.url=http://sonarqube:9000 -Dsonar.login=${SONAR_TOKEN}'
                    echo "âœ… Code quality analysis completed"
                }
            }
        }
        
        stage('ğŸ“¤ Publish to Nexus') {
            steps {
                script {
                    echo "ğŸ“¤ Publishing artifacts to Nexus..."
                    def repository = params.ENVIRONMENT == 'production' ? 'libs-release' : 'libs-snapshot'
                    sh "mvn deploy -DskipTests -DaltDeploymentRepository=nexus::default::${NEXUS_URL}/repository/${repository}"
                    echo "âœ… Artifacts published to ${repository}"
                }
            }
        }
    }
    
    post {
        success {
            echo "âœ… Build completed successfully!"
        }
        failure {
            echo "âŒ Build failed!"
        }
        always {
            cleanWs()
        }
    }
}