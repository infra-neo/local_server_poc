#!/bin/bash

echo "=== CONFIGURACIÃ“N PROXY PROVIDER EN AUTHENTIK ==="
echo "Este script te guiarÃ¡ paso a paso para configurar Proxy Provider"
echo "Forward Auth no estÃ¡ disponible, usaremos Proxy Provider como alternativa"
echo ""
echo "ğŸ”— URL de Authentik: https://34.68.124.46:9443"
echo "ğŸ‘¤ Usuario Admin: akadmin"
echo "ğŸ” Password: Neogenesys123!!!"
echo ""

echo "PASO 1: Crear Proxy Provider"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1. Ve a: Applications â†’ Providers"
echo "2. Haz clic en 'Create'"
echo "3. Selecciona: 'Proxy Provider'"
echo ""
echo "ConfiguraciÃ³n del Provider:"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ Name: Guacamole Proxy Provider                   â”‚"
echo "â”‚ Authorization flow: default-authorization-flow   â”‚"
echo "â”‚ External host: http://34.68.124.46:8080         â”‚"
echo "â”‚ Internal host: http://kolaboree-guacamole:8080   â”‚"
echo "â”‚ Internal host SSL Validation: âŒ DESMARCADO     â”‚"
echo "â”‚ Intercept header authentication: âœ… MARCADO     â”‚"
echo "â”‚ Token validity: hours=24                         â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""

echo "PASO 2: Configurar Headers Avanzados"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "En la secciÃ³n 'ADVANCED PROTOCOL SETTINGS':"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ Additional scopes: openid email profile groups            â”‚"
echo "â”‚ Mode: Forward auth (single application)                   â”‚"
echo "â”‚ Set HTTP-Basic Authentication: âŒ DESMARCADO              â”‚"
echo "â”‚ Set HTTP Authorization header: âŒ DESMARCADO              â”‚"
echo "â”‚ Custom headers:                                            â”‚"
echo "â”‚                                                            â”‚"
echo "â”‚ X-AUTHENTIK-USERNAME: user.username                       â”‚"
echo "â”‚ X-AUTHENTIK-EMAIL: user.email                             â”‚"
echo "â”‚ X-AUTHENTIK-NAME: user.name                               â”‚"
echo "â”‚ X-AUTHENTIK-GROUPS: user.groups                           â”‚"
echo "â”‚ X-AUTHENTIK-UID: user.uid                                 â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""

echo "PASO 3: Crear AplicaciÃ³n"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1. Ve a: Applications â†’ Applications"
echo "2. Haz clic en 'Create'"
echo "3. ConfiguraciÃ³n:"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ Name: Apache Guacamole SSO                       â”‚"
echo "â”‚ Slug: apache-guacamole-sso                       â”‚"
echo "â”‚ Provider: Guacamole Proxy Provider               â”‚"
echo "â”‚ Launch URL: http://34.68.124.46:8080/guacamole/  â”‚"
echo "â”‚ Icon (opcional): Upload logo si tienes           â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""

echo "PASO 4: Configurar Outpost (CRÃTICO)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1. Ve a: Applications â†’ Outposts"
echo "2. Busca el outpost 'authentik Embedded Outpost' o crea uno nuevo"
echo "3. Edita el outpost existente:"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ Name: authentik Embedded Outpost                 â”‚"
echo "â”‚ Type: Proxy                                      â”‚"
echo "â”‚ Applications: Apache Guacamole SSO               â”‚"
echo "â”‚ Configuration:                                   â”‚"
echo "â”‚   authentik_host: https://34.68.124.46:9443     â”‚"
echo "â”‚   log_level: debug                               â”‚"
echo "â”‚   docker_network: null                          â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""

echo "PASO 5: Verificar ConfiguraciÃ³n"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1. Ve a Authentik Admin â†’ System â†’ Tasks"
echo "2. Verifica que no hay errores en el outpost"
echo "3. Ve a Applications â†’ Outposts y verifica que estÃ© 'Healthy'"
echo ""

echo "PASO 6: Configurar Nginx (REQUERIDO PARA PROXY)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "El Proxy Provider requiere que Nginx haga la integraciÃ³n:"
echo ""
echo "ConfiguraciÃ³n requerida en nginx.conf:"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ server {                                                   â”‚"
echo "â”‚     listen 8080;                                          â”‚"
echo "â”‚     server_name 34.68.124.46;                            â”‚"
echo "â”‚                                                            â”‚"
echo "â”‚     location /akprox/ {                                   â”‚"
echo "â”‚         proxy_pass http://authentik-server:9000;          â”‚"
echo "â”‚     }                                                      â”‚"
echo "â”‚                                                            â”‚"
echo "â”‚     location / {                                          â”‚"
echo "â”‚         auth_request /akprox/auth/guacamole;              â”‚"
echo "â”‚         auth_request_set \$user \$upstream_http_x_authentik_username; â”‚"
echo "â”‚         auth_request_set \$email \$upstream_http_x_authentik_email;   â”‚"
echo "â”‚         proxy_set_header X-AUTHENTIK-USERNAME \$user;    â”‚"
echo "â”‚         proxy_set_header X-AUTHENTIK-EMAIL \$email;      â”‚"
echo "â”‚         proxy_pass http://kolaboree-guacamole:8080;       â”‚"
echo "â”‚     }                                                      â”‚"
echo "â”‚ }                                                          â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""

echo "PASO 7: Probar el Flujo SSO"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1. Abre una ventana de incÃ³gnito"
echo "2. Ve a: http://34.68.124.46:8080/guacamole/"
echo "3. DeberÃ­as ser redirigido a Authentik"
echo "4. Ingresa credenciales: soporte@kolaboree.local / Neo123!!!"
echo "5. DeberÃ­as ser redirigido automÃ¡ticamente a Guacamole"
echo "6. Verifica que estÃ©s logueado como 'soporte'"
echo ""

echo "ğŸ’¡ ALTERNATIVA SIMPLIFICADA: RAC PROVIDER"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Si el Proxy Provider es muy complejo, puedes usar RAC Provider:"
echo "â€¢ RAC Provider estÃ¡ especÃ­ficamente diseÃ±ado para RDP/SSH/VNC"
echo "â€¢ Integra directamente con Guacamole sin configuraciÃ³n de Nginx"
echo "â€¢ Es mÃ¡s simple de configurar"
echo ""
echo "Â¿Prefieres continuar con Proxy Provider o usar RAC Provider?"
echo ""

echo "âœ… CONFIGURACIÃ“N ACTUAL DE GUACAMOLE YA APLICADA:"
echo "â€¢ EXTENSION_PRIORITY: header,openid,ldap,*"
echo "â€¢ HTTP_AUTH_HEADER: X-AUTHENTIK-USERNAME"
echo "â€¢ HTTP_AUTH_NAME_ATTRIBUTE: username"
echo "â€¢ HTTP_AUTH_EMAIL_ATTRIBUTE: email"
echo "â€¢ HTTP_AUTH_AUTO_CREATE_USER: true"
echo ""

echo "ğŸš€ PRÃ“XIMOS PASOS:"
echo "1. Decide entre Proxy Provider (mÃ¡s complejo) o RAC Provider (mÃ¡s simple)"
echo "2. Ejecuta la configuraciÃ³n correspondiente"
echo "3. Prueba el flujo SSO completo"