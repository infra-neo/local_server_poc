#!/bin/bash

echo "=== CONFIGURACIÃ“N FORWARD AUTH PROVIDER EN AUTHENTIK ==="
echo "Este script te guiarÃ¡ paso a paso para configurar Forward Auth Provider"
echo ""
echo "ğŸ”— URL de Authentik: https://34.68.124.46:9443"
echo "ğŸ‘¤ Usuario Admin: akadmin"
echo "ğŸ” Password: Neogenesys123!!!"
echo ""

echo "PASO 1: Crear Forward Auth Provider"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1. Ve a: Applications â†’ Providers"
echo "2. Haz clic en 'Create'"
echo "3. Selecciona: 'Forward auth (single application)'"
echo ""
echo "ConfiguraciÃ³n del Provider:"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ Name: Guacamole Forward Auth                     â”‚"
echo "â”‚ External host: http://34.68.124.46:8080         â”‚"
echo "â”‚ Internal host: http://kolaboree-guacamole:8080   â”‚"
echo "â”‚ Internal host SSL Validation: âŒ DESMARCADO     â”‚"
echo "â”‚ Token validity: hours=24                         â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""

echo "PASO 2: Configurar Headers Personalizados"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "En la secciÃ³n 'ADVANCED PROTOCOL SETTINGS':"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ Additional scopes: openid email profile groups            â”‚"
echo "â”‚ Custom headers:                                            â”‚"
echo "â”‚                                                            â”‚"
echo "â”‚ {                                                          â”‚"
echo "â”‚   \"X-AUTHENTIK-USERNAME\": \"user.username\",               â”‚"
echo "â”‚   \"X-AUTHENTIK-EMAIL\": \"user.email\",                     â”‚"
echo "â”‚   \"X-AUTHENTIK-NAME\": \"user.name\",                       â”‚"
echo "â”‚   \"X-AUTHENTIK-GROUPS\": \"user.groups\",                   â”‚"
echo "â”‚   \"X-AUTHENTIK-UID\": \"user.uid\"                          â”‚"
echo "â”‚ }                                                          â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""

echo "PASO 3: Crear AplicaciÃ³n"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1. Ve a: Applications â†’ Applications"
echo "2. Haz clic en 'Create'"
echo "3. ConfiguraciÃ³n:"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ Name: Apache Guacamole Secure                    â”‚"
echo "â”‚ Slug: apache-guacamole-secure                    â”‚"
echo "â”‚ Provider: Guacamole Forward Auth                 â”‚"
echo "â”‚ Launch URL: http://34.68.124.46:8080/guacamole/  â”‚"
echo "â”‚ Icon (opcional): Upload logo si tienes           â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""

echo "PASO 4: Configurar Outpost (CRÃTICO)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1. Ve a: Applications â†’ Outposts"
echo "2. Selecciona el Outpost existente o crea uno nuevo"
echo "3. En 'Applications', agrega: 'Apache Guacamole Secure'"
echo "4. ConfiguraciÃ³n del Outpost:"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ Name: embedded-outpost                           â”‚"
echo "â”‚ Type: Forward auth (domain level)               â”‚"
echo "â”‚ Applications: Apache Guacamole Secure           â”‚"
echo "â”‚ Configuration:                                   â”‚"
echo "â”‚   authentik_host: https://34.68.124.46:9443     â”‚"
echo "â”‚   log_level: debug                               â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""

echo "PASO 5: Verificar ConfiguraciÃ³n"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1. Ve a Authentik Admin â†’ System â†’ Tasks"
echo "2. Verifica que no hay errores"
echo "3. Prueba acceder a: http://34.68.124.46:8080/guacamole/"
echo ""

echo "PASO 6: Probar el Flujo SSO"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1. Abre una ventana de incÃ³gnito"
echo "2. Ve a: http://34.68.124.46:8080/guacamole/"
echo "3. DeberÃ­as ser redirigido a Authentik"
echo "4. Ingresa credenciales: soporte@kolaboree.local / Neo123!!!"
echo "5. DeberÃ­as ser redirigido automÃ¡ticamente a Guacamole"
echo "6. Verifica que estÃ©s logueado como 'soporte'"
echo ""

echo "ğŸ’¡ NOTAS IMPORTANTES:"
echo "â€¢ Si hay errores, revisa los logs: docker logs kolaboree-authentik-server"
echo "â€¢ Los headers personalizados son crÃ­ticos para el funcionamiento"
echo "â€¢ El Outpost debe estar asociado a la aplicaciÃ³n"
echo "â€¢ Guacamole debe estar configurado con header authentication"
echo ""

echo "âœ… CONFIGURACIÃ“N ACTUAL DE GUACAMOLE YA APLICADA:"
echo "â€¢ EXTENSION_PRIORITY: header,openid,ldap,*"
echo "â€¢ HTTP_AUTH_HEADER: X-AUTHENTIK-USERNAME"
echo "â€¢ HTTP_AUTH_NAME_ATTRIBUTE: username"
echo "â€¢ HTTP_AUTH_EMAIL_ATTRIBUTE: email"
echo "â€¢ HTTP_AUTH_AUTO_CREATE_USER: true"
echo ""

echo "ğŸš€ Â¡DespuÃ©s de completar estos pasos, tendrÃ¡s SSO completo!"
echo "ğŸ” Los usuarios se autenticarÃ¡n en Authentik y accederÃ¡n automÃ¡ticamente a Guacamole"