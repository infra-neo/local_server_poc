#!/bin/bash
# GuÃ­a paso a paso para crear la aplicaciÃ³n RAC en Authentik

echo "ğŸ¯ SOLUCIÃ“N: CREAR APLICACIÃ“N RAC EN AUTHENTIK"
echo "=============================================="

echo ""
echo "âœ… DIAGNÃ“STICO CONFIRMADO:"
echo "â€¢ RAC Provider configurado correctamente âœ“"
echo "â€¢ Authentik interfaz funcionando âœ“"
echo "â€¢ Guacamole con OIDC configurado âœ“"
echo "âŒ FALTA: Application en Authentik"

echo ""
echo "ğŸ”§ PASOS EXACTOS PARA SOLUCIONAR:"
echo "================================="

echo ""
echo "PASO 1: Acceder a Authentik Admin"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "1. Abrir: https://34.68.124.46:9443/if/admin/"
echo "2. Login como akadmin"

echo ""
echo "PASO 2: Crear la Application"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "1. En el menÃº lateral: Applications > Applications"
echo "2. Hacer clic en '+ Create' (botÃ³n azul)"
echo "3. Llenar el formulario EXACTAMENTE asÃ­:"
echo ""
echo "   ğŸ“‹ CONFIGURACIÃ“N EXACTA:"
echo "   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "   â”‚ Name: Apache Guacamole                          â”‚"
echo "   â”‚ Slug: guacamole                                 â”‚"
echo "   â”‚ Group: (dejar vacÃ­o)                            â”‚"
echo "   â”‚ Provider: [Seleccionar tu RAC Provider]         â”‚"
echo "   â”‚                                                 â”‚"
echo "   â”‚ BACKCHANNEL PROVIDERS: (dejar vacÃ­o)            â”‚"
echo "   â”‚                                                 â”‚"
echo "   â”‚ UI SETTINGS:                                    â”‚"
echo "   â”‚ Launch URL: http://34.68.124.46:8080/guacamole/ â”‚"
echo "   â”‚ Open in new tab: âœ… (marcado)                  â”‚"
echo "   â”‚                                                 â”‚"
echo "   â”‚ ICON:                                           â”‚"
echo "   â”‚ Icon: /static/dist/assets/icons/icon.svg        â”‚"
echo "   â”‚ (Opcional: Usar el logo de Neogenesys)         â”‚"
echo "   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""
echo "4. Hacer clic en 'Create'"

echo ""
echo "PASO 3: Asignar permisos al usuario"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "1. DespuÃ©s de crear la aplicaciÃ³n, ir a la pestaÃ±a:"
echo "   'Policy / Group / User Bindings'"
echo "2. Hacer clic en 'Create Binding'"
echo "3. Configurar:"
echo "   â€¢ Target: User"
echo "   â€¢ User: soporte (o el usuario que quieras que tenga acceso)"
echo "   â€¢ Enabled: âœ…"
echo "4. Hacer clic en 'Create'"

echo ""
echo "PASO 4: Verificar la aplicaciÃ³n"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "1. Logout de Authentik Admin"
echo "2. Ir a: https://34.68.124.46:9443/if/user/"
echo "3. Login: soporte@kolaboree.local / Neo123!!!"
echo "4. Verificar que aparezca 'Apache Guacamole' en la lista"

echo ""
echo "PASO 5: Probar el SSO"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "1. Hacer clic en 'Apache Guacamole'"
echo "2. DeberÃ­a abrir Guacamole automÃ¡ticamente"
echo "3. Sin pedir credenciales adicionales"
echo "4. Mostrar las conexiones RDP disponibles"

echo ""
echo "ğŸš¨ TROUBLESHOOTING:"
echo "==================="
echo ""
echo "SI LA APLICACIÃ“N NO APARECE:"
echo "â€¢ Verificar que el binding del usuario estÃ© creado"
echo "â€¢ Verificar que la aplicaciÃ³n estÃ© 'Enabled'"
echo "â€¢ Logout y login nuevamente en Authentik"
echo ""
echo "SI DA ERROR AL HACER CLIC:"
echo "â€¢ Verificar Launch URL: http://34.68.124.46:8080/guacamole/"
echo "â€¢ Verificar que el Provider estÃ© asignado correctamente"
echo "â€¢ Revisar logs: docker logs kolaboree-guacamole"
echo ""
echo "SI GUACAMOLE PIDE LOGIN:"
echo "â€¢ Verificar Client Secret en docker-compose.yml"
echo "â€¢ Verificar que OPENID_ENABLED=true"
echo "â€¢ Verificar Redirect URI en el Provider"

echo ""
echo "ğŸ“‹ INFORMACIÃ“N DE CONFIGURACIÃ“N:"
echo "================================"
echo "Provider Client ID: guacamole-rac-client"
echo "Provider Client Secret: (visible en docker-compose.yml)"
echo "Application Launch URL: http://34.68.124.46:8080/guacamole/"
echo "Application Slug: guacamole"

echo ""
echo "âœ… DESPUÃ‰S DE COMPLETAR ESTOS PASOS:"
echo "===================================="
echo "El flujo serÃ¡:"
echo "1. Usuario â†’ https://34.68.124.46:9443/if/user/"
echo "2. Login â†’ Ve aplicaciÃ³n 'Apache Guacamole'"
echo "3. Click â†’ Abre Guacamole con SSO"
echo "4. Acceso â†’ Ve conexiones RDP sin login adicional"

echo ""
echo "ğŸ‰ Â¡SSO AUTHENTIK-GUACAMOLE FUNCIONARÃ COMPLETAMENTE!"